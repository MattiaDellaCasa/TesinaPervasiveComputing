{% extends "base.html" %}

{% block content %}
<div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
    <h1 class="h2">Dashboard Mining</h1>
    <div class="btn-toolbar mb-2 mb-md-0">
        <button class="btn btn-sm btn-outline-secondary" onclick="location.reload()">
            <i class="fas fa-sync-alt"></i> Aggiorna
        </button>
    </div>
</div>

<div class="row">
    <div class="col-md-6">
        <div class="card stats-card">
            <div class="card-body">
                <h5 class="card-title">% Silica Attuale</h5>
                <h2 class="text-primary" id="current-silica">--</h2>
            </div>
        </div>
    </div>
    <div class="col-md-6">
        <div class="card stats-card">
            <div class="card-body">
                <h5 class="card-title">Dati Ricevuti</h5>
                <h2 class="text-warning" id="data-count">0</h2>
            </div>
        </div>
    </div>
</div>

<div class="row mt-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <i class="fas fa-chart-line"></i> Andamento % Silica - Dati da Cloud
            </div>
            <div class="card-body">
                <div id="silica-chart" style="height: 400px;">
                    <div class="d-flex justify-content-center align-items-center" style="height: 400px;">
                        <div class="text-center">
                            <div class="spinner-border text-primary" role="status">
                                <span class="visually-hidden">Caricamento...</span>
                            </div>
                            <p class="mt-2">Caricamento dati...</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
function showError(message) {
    document.getElementById('silica-chart').innerHTML = `
        <div class="alert alert-warning text-center" style="margin: 50px;">
            <i class="fas fa-exclamation-triangle"></i>
            <h5>Nessun Dato Disponibile</h5>
            <p>${message}</p>
            <button class="btn btn-primary" onclick="location.reload()">
                <i class="fas fa-refresh"></i> Riprova
            </button>
        </div>
    `;
}

function updateStats(stats) {
    console.log('Aggiornamento statistiche:', stats);
    document.getElementById('current-silica').textContent = 
        (stats.current_silica || 0).toFixed(2) + '%';
    document.getElementById('data-count').textContent = stats.data_points || 0;
}

// Carica dati dashboard
console.log('Caricamento dati dashboard...');
fetch('/api/charts/realtime')
    .then(response => {
        console.log('Risposta ricevuta:', response.status);
        return response.json();
    })
    .then(data => {
        console.log('Dati ricevuti:', data);
        
        // Controlla se ci sono errori
        if (data.error) {
            console.warn('Errore nei dati:', data.error);
            showError(data.error);
            updateStats(data.stats || {});
            return;
        }
        
        // Controlla se esistono i grafici
        if (!data.silica_trend) {
            console.warn('Dati del grafico mancanti');
            showError('Dati del grafico non disponibili');
            updateStats(data.stats || {});
            return;
        }
        
        // Aggiorna statistiche
        updateStats(data.stats || {});
        
        // Visualizza grafico
        try {
            console.log('Creazione grafico Plotly...');
            Plotly.newPlot('silica-chart', data.silica_trend_simple.data, data.silica_trend_simple.layout);
            console.log('Grafico creato con successo');
        } catch (error) {
            console.error('Errore creazione grafico:', error);
            showError('Errore nella visualizzazione del grafico');
        }
    })
    .catch(error => {
        console.error('Errore fetch:', error);
        showError('Errore di connessione al server');
        updateStats({});
    });

// Auto-refresh ogni 30 secondi
setInterval(() => {
    console.log('Auto-refresh...');
    location.reload();
}, 30000);
</script>
{% endblock %}