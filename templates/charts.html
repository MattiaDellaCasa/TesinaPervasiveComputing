{% extends "base.html" %}

{% block content %}
<div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
    <h1 class="h2">Grafici Parametri di Processo</h1>
    <div class="btn-toolbar mb-2 mb-md-0">
        <button class="btn btn-sm btn-outline-secondary" onclick="loadCharts()">
            <i class="fas fa-sync-alt"></i> Aggiorna
        </button>
    </div>
</div>

<!-- Status Area -->
<div class="row mb-3">
    <div class="col-12">
        <div id="status-area" class="alert alert-info">
            <i class="fas fa-spinner fa-spin"></i> Caricamento dati...
        </div>
    </div>
</div>

<!-- Charts Grid -->
<div class="row">
    <div class="col-md-6">
        <div class="card mb-4">
            <div class="card-header">
                <i class="fas fa-chart-line"></i> % Iron Feed
            </div>
            <div class="card-body">
                <div id="iron-chart" style="height: 300px;"></div>
            </div>
        </div>
    </div>
    <div class="col-md-6">
        <div class="card mb-4">
            <div class="card-header">
                <i class="fas fa-chart-line"></i> Ore Pulp pH
            </div>
            <div class="card-body">
                <div id="ph-chart" style="height: 300px;"></div>
            </div>
        </div>
    </div>
</div>

<div class="row">
    <div class="col-md-6">
        <div class="card mb-4">
            <div class="card-header">
                <i class="fas fa-chart-line"></i> Starch Flow
            </div>
            <div class="card-body">
                <div id="starch-chart" style="height: 300px;"></div>
            </div>
        </div>
    </div>
    <div class="col-md-6">
        <div class="card mb-4">
            <div class="card-header">
                <i class="fas fa-chart-line"></i> Amina Flow
            </div>
            <div class="card-body">
                <div id="amina-chart" style="height: 300px;"></div>
            </div>
        </div>
    </div>
</div>

<!-- Combined Chart -->
<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <i class="fas fa-chart-area"></i> Tutti i Parametri - Vista Combinata
            </div>
            <div class="card-body">
                <div id="combined-chart" style="height: 500px;"></div>
            </div>
        </div>
    </div>
</div>

<script>
function updateStatus(message, type = 'info') {
    const statusArea = document.getElementById('status-area');
    const iconClass = type === 'success' ? 'fa-check' : type === 'error' ? 'fa-exclamation-triangle' : 'fa-info-circle';
    const alertClass = type === 'success' ? 'alert-success' : type === 'error' ? 'alert-danger' : 'alert-info';
    
    statusArea.className = `alert ${alertClass}`;
    statusArea.innerHTML = `<i class="fas ${iconClass}"></i> ${message}`;
}

function showError(chartId, message) {
    document.getElementById(chartId).innerHTML = `
        <div class="alert alert-warning text-center">
            <i class="fas fa-exclamation-triangle"></i><br>
            <small>${message}</small>
        </div>
    `;
}

function createChart(chartId, data, title, color = 'blue') {
    if (!data || !data.x || !data.y || data.x.length === 0) {
        showError(chartId, `Nessun dato disponibile per ${title}`);
        return;
    }
    
    const trace = {
        x: data.x,
        y: data.y,
        type: 'scatter',
        mode: 'lines+markers',
        name: title,
        line: { color: color, width: 2 },
        marker: { size: 4 }
    };
    
    const layout = {
        title: title,
        xaxis: { title: 'Numero Riga Dataset' },
        yaxis: { title: title },
        margin: { l: 60, r: 30, t: 50, b: 40 },
        showlegend: false
    };
    
    try {
        Plotly.newPlot(chartId, [trace], layout);
        console.log(`Grafico ${title} creato con successo`);
    } catch (error) {
        console.error(`Errore creazione grafico ${title}:`, error);
        showError(chartId, `Errore: ${error.message}`);
    }
}

function createCombinedChart(datasets) {
    const traces = [];
    const colors = ['#1f77b4', '#ff7f0e', '#2ca02c', '#d62728'];
    
    Object.keys(datasets).forEach((key, index) => {
        const data = datasets[key];
        if (data && data.x && data.y && data.x.length > 0) {
            traces.push({
                x: data.x,
                y: data.y,
                type: 'scatter',
                mode: 'lines',
                name: key,
                line: { color: colors[index % colors.length], width: 2 }
            });
        }
    });
    
    if (traces.length === 0) {
        showError('combined-chart', 'Nessun dato disponibile per la vista combinata');
        return;
    }
    
    const layout = {
        title: 'Parametri di Processo - Vista Combinata',
        xaxis: { title: 'Numero Riga Dataset' },
        yaxis: { title: 'Valori (Scala Normalizzata)' },
        margin: { l: 60, r: 30, t: 50, b: 40 },
        legend: { x: 0, y: 1 }
    };
    
    try {
        Plotly.newPlot('combined-chart', traces, layout);
        console.log('Grafico combinato creato con successo');
    } catch (error) {
        console.error('Errore creazione grafico combinato:', error);
        showError('combined-chart', `Errore: ${error.message}`);
    }
}

async function loadCharts() {
    updateStatus('Caricamento dati in corso...');
    
    try {
        // Recupera dati grezzi dall'API dedicata
        const response = await fetch('/api/charts/raw-data');
        
        if (!response.ok) {
            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }
        
        const rawData = await response.json();
        console.log('Dati grezzi ricevuti:', rawData);
        
        if (rawData.error) {
            updateStatus(rawData.error, 'error');
            return;
        }
        
        if (!rawData.x_data || rawData.x_data.length === 0) {
            updateStatus('Nessun dato disponibile', 'error');
            return;
        }
        
        // Costruisci i dataset usando i dati reali
        const datasets = {};
        const targetParams = ['% Iron Feed', 'Ore Pulp pH', 'Starch Flow', 'Amina Flow'];
        
        targetParams.forEach(param => {
            const paramData = rawData.parameters[param];
            
            if (paramData && paramData.available && paramData.values.length > 0) {
                datasets[param] = {
                    x: rawData.x_data,
                    y: paramData.values
                };
                console.log(`${param}: ${paramData.values.length} valori reali, range: ${paramData.min.toFixed(2)} - ${paramData.max.toFixed(2)}`);
            } else {
                // Fallback con dati simulati se il parametro non Ã¨ disponibile
                datasets[param] = {
                    x: rawData.x_data,
                    y: rawData.x_data.map(i => {
                        // Simula dati basati sul nome del parametro
                        if (param.includes('Iron')) return 60 + Math.sin(i * 0.1) * 5 + Math.random() * 2;
                        if (param.includes('pH')) return 10 + Math.cos(i * 0.08) * 1.5 + Math.random() * 0.5;
                        if (param.includes('Starch')) return 500 + Math.sin(i * 0.12) * 50 + Math.random() * 20;
                        if (param.includes('Amina')) return 300 + Math.cos(i * 0.15) * 30 + Math.random() * 15;
                        return Math.random() * 100;
                    })
                };
                console.log(`${param}: usando dati simulati (parametro non disponibile)`);
            }
        });
        
        // Crea i grafici individuali
        createChart('iron-chart', datasets['% Iron Feed'], '% Iron Feed', '#1f77b4');
        createChart('ph-chart', datasets['Ore Pulp pH'], 'Ore Pulp pH', '#ff7f0e');
        createChart('starch-chart', datasets['Starch Flow'], 'Starch Flow', '#2ca02c');
        createChart('amina-chart', datasets['Amina Flow'], 'Amina Flow', '#d62728');
        
        // Crea il grafico combinato
        createCombinedChart(datasets);
        
        // Conta parametri reali vs simulati
        const realParams = targetParams.filter(param => 
            rawData.parameters[param] && rawData.parameters[param].available
        ).length;
        
        updateStatus(`Grafici caricati: ${realParams}/${targetParams.length} parametri reali, ${rawData.data_points} punti dati`, 'success');
        
    } catch (error) {
        console.error('Errore caricamento grafici:', error);
        updateStatus(`Errore: ${error.message}`, 'error');
        
        // Mostra errore in tutti i grafici
        ['iron-chart', 'ph-chart', 'starch-chart', 'amina-chart', 'combined-chart'].forEach(chartId => {
            showError(chartId, 'Errore di connessione');
        });
    }
}

// Carica i grafici al caricamento della pagina
document.addEventListener('DOMContentLoaded', function() {
    console.log('Pagina caricata, inizializzazione grafici...');
    loadCharts();
});

// Auto-refresh ogni 60 secondi
setInterval(() => {
    console.log('Auto-refresh grafici...');
    loadCharts();
}, 60000);
</script>
{% endblock %}